<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="ETAS.inlabru">
<title>Tutorial on real data â€¢ ETAS.inlabru</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Tutorial on real data">
<meta property="og:description" content="ETAS.inlabru">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">ETAS.inlabru</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.1.0.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/generateSyntheticCatalogues.html">Generating synthetic temporal ETAS catalogues</a>
    <a class="dropdown-item" href="../articles/sensitivityToStartingPoint.html">Sensitivity to starting point</a>
    <a class="dropdown-item" href="../articles/tutorial_real.html">Tutorial on real data</a>
    <a class="dropdown-item" href="../articles/tutorial_synth.html">Tutorial on synthetic data</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/edinburgh-seismicity-hub/ETAS.inlabru/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Tutorial on real data</h1>
                        <h4 data-toc-skip class="author">Francesco
Serafini</h4>
            
            <h4 data-toc-skip class="date">2023-06-27</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/edinburgh-seismicity-hub/ETAS.inlabru/blob/HEAD/vignettes/articles/tutorial_real.Rmd" class="external-link"><code>vignettes/articles/tutorial_real.Rmd</code></a></small>
      <div class="d-none name"><code>tutorial_real.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://edinburgh-seismicity-hub.github.io/ETAS.inlabru/">ETAS.inlabru</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Increase num.threads if you have more cores on your computer</span></span>
<span><span class="fu">INLA</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/INLA/man/options.html" class="external-link">inla.setOption</a></span><span class="op">(</span>num.threads <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="introduction-to-etas-model">Introduction to ETAS model<a class="anchor" aria-label="anchor" href="#introduction-to-etas-model"></a>
</h2>
<p>In this tutorial, we show how to use the <code>ETAS.inlabru</code>
R-package to fit a temporal ETAS model on real earthquakes data. The
tutorial shows how to prepare the data, how to fit a model, how to
retrieve the posterior distribution of the parameters and the posterior
distribution of other quantities of interest, how to generate synthetic
catalogues from the fitted model, and how to produce forecasts of
seismicity.</p>
<p>The Epidemic-Type Aftershock Sequence (ETAS) model belongs to the
family of Hawkes (or ) point processes. The temporal Hawkes process is a
point process model with conditional intensity given by</p>
<p><span class="math display">\[
\lambda(t | \mathcal H_t) = \mu + \sum_{t_h \in \mathcal H_t} g(t- t_h)
\]</span> where <span class="math inline">\(\mathcal H_t\)</span> is the
history of the process up to time <span class="math inline">\(t\)</span>. Generally speaking <span class="math inline">\(\mathcal H_t\)</span> contains all the events
occurred before <span class="math inline">\(t\)</span>. The quantity
<span class="math inline">\(\mu &gt; 0\)</span> is usually called the ,
and is interpreted as the rate at which events occur spontaneously. The
function <span class="math inline">\(g(t-t_h)\)</span> is called
function (or excitation function, or simply kernel) and measures the
influence of having an event in <span class="math inline">\(t_h\)</span>
on time <span class="math inline">\(t\)</span>. If we look at <span class="math inline">\(g(t-t_h)\)</span> as a function of <span class="math inline">\(t\)</span> is the intensity of the point process
representing the offspring of the event in <span class="math inline">\(t_h\)</span>. In seismology the offspring of an
event are called , the two terms will be used as synonyms. In essence,
an Hawkes process model can be seen as the superposition of a background
process with intensity <span class="math inline">\(\mu\)</span> and all
the aftershock processes generated by the observations in <span class="math inline">\(\mathcal H_t\)</span> each one with intensity
<span class="math inline">\(g(t-t_h)\)</span>. This makes Hawkes process
model particularly suitable to describe phenomena in which an event has
the ability to trigger additional events, phenomena characterized by
cascades of events such as earthquakes, infectious diseases, wildfires,
financial crisis, and similar.</p>
<p>The ETAS model is a particular instance of Hawkes process model which
has proven to be particularly suitable to model earthquake occurrence.
Earthquakes are usually described and modelled as marked time points
where the marking variable is the magnitude of the event. So the history
of the process is composed by time-magnitude pairs, namely <span class="math inline">\(\mathcal H_t = \{(t_h,m_h), h =
1,...,N_h\}\)</span>. Various slightly different ETAS formulations
exists, usually characterized by slightly different triggering
functions, the one that is implemented in the <code>ETAS.inlabru</code>
R-package has conditional intensity given by</p>
<p><span class="math display">\[
\lambda(t | \mathcal H_t) = \mu + \sum_{t_h \in \mathcal H_t} K
\exp\{\alpha(m_h - M_0)\}\left(\frac{t - t_h}{c} + 1\right)^{-p}
\]</span> where <span class="math inline">\(M_0\)</span> is the cutoff
magnitude such that <span class="math inline">\(m_h \geq M_0\)</span>
for any <span class="math inline">\(h\)</span>. This value is decided a
priori based on the quality of the catalogue used.</p>
<p>The parameters of the model are:</p>
<ul>
<li>
<span class="math inline">\(\mu \geq 0\)</span>, the background
rate</li>
<li>
<span class="math inline">\(K \geq 0\)</span> a general productivity
parameter, it plays a role in determining the average number of
aftershocks induced by any event in the catalogue.</li>
<li>
<span class="math inline">\(\alpha \geq 0\)</span> a magnitude
scaling parameter, it determines how the number of aftershocks changes
based on the magnitude of the event generating the aftershocks. It has
to be non-negative to reflect the fact that stronger earthquakes
generate more aftershocks.</li>
<li>
<span class="math inline">\(c &gt; 0\)</span> a time offset
parameter, smaller values are associated with catalogues with fewer
missing events.</li>
<li>
<span class="math inline">\(p \geq 1\)</span> an aftershock decay
parameter, it determines the rate at which the aftershock activity
decreases over time. It has to be greater than 1 otherwise an event may
generate an infinite number of aftershocks in an infinite interval of
time which is thought to be unphysical.</li>
</ul>
</div>
<div class="section level2">
<h2 id="priors">Priors<a class="anchor" aria-label="anchor" href="#priors"></a>
</h2>
<p>As any other bayesian analysis we need to decide the priors of the
parameters. The approximation method that we use considers the
parameters in two different scales: the original ETAS scale, and the
internal scale. The internal scale is used by the package to perform the
calculations. In the internal scale the parameters does not have any
constraint and have a standard normal distribution as prior. We need to
set up the priors for the parameters in the ETAS scale. This is done by
considering a copula transformation <span class="math inline">\(\eta(X)\)</span> such that if <span class="math inline">\(X \sim N(0,1)\)</span> then, <span class="math inline">\(\eta(X)\)</span> has the desired distribution.</p>
<p>The <code>ETAS.inlabru</code> R-package provides four different
functions corresponding to three different distributions:</p>
<ol style="list-style-type: decimal">
<li><p><code>gamma_t(X, a, b)</code> for a Gamma distribution with shape
parameter <code>a</code> and rate <code>b</code>. The distribution is
such that the mean is <code>\texttt{a}/\texttt{b}</code> and the
variance is <span class="math inline">\(\texttt{a}/\texttt{b}^2\)</span>.</p></li>
<li><p><code>unit_t(X, a, b)</code> for a Uniform distribution between
<code>a</code> and <code>b</code>.</p></li>
<li><p><code>exp_t(X, r)</code> for an Exponential distribution with
rate <code>r</code>.</p></li>
<li><p><code>loggaus_t(X, m ,s)</code> for a Log-Gaussian distribution
with mean of the logarithm <code>m</code> and standard deviation of the
logarithm <code>s</code>.</p></li>
</ol>
<p>The code below generate 1000 observations from a normal distribution,
transform them using the functions provided by the package, and shows
the empirical density estimated from the sample.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># obtain sample from standard normal distribution</span></span>
<span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">1000</span><span class="op">)</span></span>
<span><span class="co"># apply copula transformations</span></span>
<span><span class="va">gamma.X</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/gamma_t.html">gamma_t</a></span><span class="op">(</span><span class="va">X</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">unif.X</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/unif_t.html">unif_t</a></span><span class="op">(</span><span class="va">X</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">exp.X</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/exp_t.html">exp_t</a></span><span class="op">(</span><span class="va">X</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">loggaus.X</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/loggaus_t.html">loggaus_t</a></span><span class="op">(</span><span class="va">X</span>, <span class="fl">0.5</span>, <span class="fl">0.5</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># build data.frame for plotting</span></span>
<span><span class="va">df.to.plot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    value <span class="op">=</span> <span class="va">X</span>,</span>
<span>    distribution <span class="op">=</span> <span class="st">"Std Normal"</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    value <span class="op">=</span> <span class="va">gamma.X</span>,</span>
<span>    distribution <span class="op">=</span> <span class="st">"Gamma"</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    value <span class="op">=</span> <span class="va">unif.X</span>,</span>
<span>    distribution <span class="op">=</span> <span class="st">"Uniform"</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    value <span class="op">=</span> <span class="va">exp.X</span>,</span>
<span>    distribution <span class="op">=</span> <span class="st">"Exponential"</span></span>
<span>  <span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    value <span class="op">=</span> <span class="va">loggaus.X</span>,</span>
<span>    distribution <span class="op">=</span> <span class="st">"Log-Gaussian"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># plot them</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">df.to.plot</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html" class="external-link">geom_histogram</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span>facets <span class="op">=</span> <span class="op">~</span><span class="va">distribution</span>, scales <span class="op">=</span> <span class="st">"free"</span><span class="op">)</span></span>
<span><span class="co">#&gt; `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</span></span></code></pre></div>
<p><img src="tutorial_real_files/figure-html/unnamed-chunk-1-1.png" width="700"></p>
<p>The package also provide inverse functions to retrieve the value of a
parameter in the internal scale if the value in the ETAS scale is
provided. Below an example</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/inv_gamma_t.html">inv_gamma_t</a></span><span class="op">(</span><span class="fu"><a href="../reference/gamma_t.html">gamma_t</a></span><span class="op">(</span><span class="fl">1.2</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1.2</span></span>
<span><span class="fu"><a href="../reference/inv_unif_t.html">inv_unif_t</a></span><span class="op">(</span><span class="fu"><a href="../reference/unif_t.html">unif_t</a></span><span class="op">(</span><span class="fl">1.2</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1.2</span></span>
<span><span class="fu"><a href="../reference/inv_exp_t.html">inv_exp_t</a></span><span class="op">(</span><span class="fu"><a href="../reference/exp_t.html">exp_t</a></span><span class="op">(</span><span class="fl">1.2</span>, <span class="fl">1</span><span class="op">)</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1.2</span></span>
<span><span class="fu"><a href="../reference/inv_loggaus_t.html">inv_loggaus_t</a></span><span class="op">(</span><span class="fu"><a href="../reference/loggaus_t.html">loggaus_t</a></span><span class="op">(</span><span class="fl">1.2</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span>, <span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1.2</span></span></code></pre></div>
<p>Once we have decided the priors that we are going to use in the
analysis, we need to store the corresponding copula transformations in a
<code>list</code>. The <code>list</code> one element for each parameter
of the model (<span class="math inline">\(5\)</span>), and each element
of the list must have name corresponding to the parameter. The names are
fixed and should be <code>mu</code>, <code>K</code>, <code>alpha</code>,
<code>c_</code>, and <code>p</code>. The parameter <span class="math inline">\(c\)</span> is referred as <code>c_</code> to avoid
clashing names with the R function <code><a href="https://rdrr.io/r/base/c.html" class="external-link">c()</a></code>. It is useful to do
the same with the inverse functions also, this list will be used to set
the initial value of the parameters later. The code below assumes that
parameter <span class="math inline">\(\mu\)</span> has a Gamma
distribution as prior with parameters <span class="math inline">\(0.3\)</span> and <span class="math inline">\(0.6\)</span>, parameters <span class="math inline">\(K, \alpha,\)</span> and <span class="math inline">\(c\)</span> have a Uniform prior on <span class="math inline">\((0,10)\)</span>, while the parameter <span class="math inline">\(p\)</span> has a Uniform prior on <span class="math inline">\((1,10)\)</span>.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># set copula transformations list</span></span>
<span><span class="va">link.f</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  mu <span class="op">=</span> \<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="../reference/gamma_t.html">gamma_t</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">0.3</span>, <span class="fl">0.6</span><span class="op">)</span>,</span>
<span>  K <span class="op">=</span> \<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="../reference/unif_t.html">unif_t</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">0</span>, <span class="fl">10</span><span class="op">)</span>,</span>
<span>  alpha <span class="op">=</span> \<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="../reference/unif_t.html">unif_t</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">0</span>, <span class="fl">10</span><span class="op">)</span>,</span>
<span>  c_ <span class="op">=</span> \<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="../reference/unif_t.html">unif_t</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">0</span>, <span class="fl">10</span><span class="op">)</span>,</span>
<span>  p <span class="op">=</span> \<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="../reference/unif_t.html">unif_t</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">1</span>, <span class="fl">10</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># set inverse copula transformations list</span></span>
<span><span class="va">inv.link.f</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  mu <span class="op">=</span> \<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="../reference/inv_gamma_t.html">inv_gamma_t</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">0.3</span>, <span class="fl">0.6</span><span class="op">)</span>,</span>
<span>  K <span class="op">=</span> \<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="../reference/inv_unif_t.html">inv_unif_t</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">0</span>, <span class="fl">10</span><span class="op">)</span>,</span>
<span>  alpha <span class="op">=</span> \<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="../reference/inv_unif_t.html">inv_unif_t</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">0</span>, <span class="fl">10</span><span class="op">)</span>,</span>
<span>  c_ <span class="op">=</span> \<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="../reference/inv_unif_t.html">inv_unif_t</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">0</span>, <span class="fl">10</span><span class="op">)</span>,</span>
<span>  p <span class="op">=</span> \<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="../reference/inv_unif_t.html">inv_unif_t</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">1</span>, <span class="fl">10</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="laquila-seismic-sequence">Lâ€™Aquila seismic sequence<a class="anchor" aria-label="anchor" href="#laquila-seismic-sequence"></a>
</h2>
<p>Earthquake data is stored in the so-called earthquake catalogues.
Many different catalogues exists for the same region and there is no
easy way to decide which one is better. Here, we provide the HOmogenized
instRUmental Seismic (HORUS) catalogue from 1960 to 2020. It can be
downloaded from <a href="http://horus.bo.ingv.it/" class="external-link">http://horus.bo.ingv.it/</a>. The whole
Horus catalogue can be loaded using</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># load ISIDE catalogue</span></span>
<span><span class="va">horus</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.table</a></span><span class="op">(</span></span>
<span>  file <span class="op">=</span> <span class="st">"data/HORUS.txt"</span>,</span>
<span>  header <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  sep <span class="op">=</span> <span class="st">","</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">horus</span><span class="op">)</span></span>
<span><span class="co">#&gt;       lon     lat    M            time_string depth catalog_id event_id</span></span>
<span><span class="co">#&gt; 1 15.3000 39.3000 6.34 1960-01-03T20:19:34.00   290         -1       NA</span></span>
<span><span class="co">#&gt; 2 13.1667 43.1333 3.94 1960-01-04T09:20:00.00     0         -1       NA</span></span>
<span><span class="co">#&gt; 3 12.7000 46.4833 4.69 1960-01-06T15:17:34.00     4         -1       NA</span></span>
<span><span class="co">#&gt; 4 12.7000 46.4667 4.14 1960-01-06T15:20:53.00     0         -1       NA</span></span>
<span><span class="co">#&gt; 5 12.7500 46.4333 3.00 1960-01-06T15:31:00.00     0         -1       NA</span></span>
<span><span class="co">#&gt; 6 12.7500 46.4333 3.00 1960-01-06T15:45:00.00     0         -1       NA</span></span></code></pre></div>
<p>The data reports for each earthquake the longitude (<code>lon</code>)
and latitude (<code>lat</code>) of the epicentre, the moment magnitude
(<code>M</code>), the time as a string (<code>time_string</code>), the
depth in kilometres (<code>depth</code>), and a catalogue and event
IDs.</p>
<p>To focus on the Lâ€™Aquila seismic sequence is sufficient to retain
only the observations in a specific space-time-magnitude region that
include the sequence of interest. For the Lâ€™Aquila sequence, we retain
all the events with magnitude greater or equal than <span class="math inline">\(2.5\)</span> happened during 2009 with longitude
in <span class="math inline">\((10.5, 16)\)</span> and latitude in <span class="math inline">\((40.5, 45)\)</span>. The Lâ€™Aquila sequence
selected in this way should be composed by 1024 events. Any other
seismic sequence can be selected similarly.</p>
<p>To do the selection is convenient to transform the time string in a
<code>Date</code> object and to select the rows of the Horus catalogue
verifying the conditions.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># transform time string in Date object</span></span>
<span><span class="va">time_string</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"T"</span>, <span class="st">" "</span>, <span class="va">horus</span><span class="op">$</span><span class="va">time_string</span><span class="op">)</span></span>
<span><span class="va">horus</span><span class="op">$</span><span class="va">time_date</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html" class="external-link">as.POSIXct</a></span><span class="op">(</span><span class="va">time_string</span>,</span>
<span>  format <span class="op">=</span> <span class="st">"%Y-%m-%d %H:%M:%OS"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># set up parameters for selection</span></span>
<span><span class="va">start.date</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html" class="external-link">as.POSIXct</a></span><span class="op">(</span><span class="st">"2009-01-01 00:00:00"</span>, format <span class="op">=</span> <span class="st">"%Y-%m-%d %H:%M:%OS"</span><span class="op">)</span></span>
<span><span class="va">end.date</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html" class="external-link">as.POSIXct</a></span><span class="op">(</span><span class="st">"2010-01-01 00:00:00"</span>, format <span class="op">=</span> <span class="st">"%Y-%m-%d %H:%M:%OS"</span><span class="op">)</span></span>
<span><span class="va">min.longitude</span> <span class="op">&lt;-</span> <span class="fl">10.5</span></span>
<span><span class="va">max.longitude</span> <span class="op">&lt;-</span> <span class="fl">16</span></span>
<span><span class="va">min.latitude</span> <span class="op">&lt;-</span> <span class="fl">40.5</span></span>
<span><span class="va">max.latitude</span> <span class="op">&lt;-</span> <span class="fl">45</span></span>
<span><span class="va">M0</span> <span class="op">&lt;-</span> <span class="fl">2.5</span></span>
<span></span>
<span><span class="co"># set up conditions for selection</span></span>
<span><span class="va">aquila.sel</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">horus</span><span class="op">$</span><span class="va">time_date</span> <span class="op">&gt;=</span> <span class="va">start.date</span><span class="op">)</span> <span class="op">&amp;</span></span>
<span>  <span class="op">(</span><span class="va">horus</span><span class="op">$</span><span class="va">time_date</span> <span class="op">&lt;</span> <span class="va">end.date</span><span class="op">)</span> <span class="op">&amp;</span></span>
<span>  <span class="op">(</span><span class="va">horus</span><span class="op">$</span><span class="va">lon</span> <span class="op">&gt;=</span> <span class="va">min.longitude</span><span class="op">)</span> <span class="op">&amp;</span></span>
<span>  <span class="op">(</span><span class="va">horus</span><span class="op">$</span><span class="va">lon</span> <span class="op">&lt;=</span> <span class="va">max.longitude</span><span class="op">)</span> <span class="op">&amp;</span></span>
<span>  <span class="op">(</span><span class="va">horus</span><span class="op">$</span><span class="va">lat</span> <span class="op">&gt;=</span> <span class="va">min.latitude</span><span class="op">)</span> <span class="op">&amp;</span></span>
<span>  <span class="op">(</span><span class="va">horus</span><span class="op">$</span><span class="va">lat</span> <span class="op">&lt;=</span> <span class="va">max.latitude</span><span class="op">)</span> <span class="op">&amp;</span></span>
<span>  <span class="op">(</span><span class="va">horus</span><span class="op">$</span><span class="va">M</span> <span class="op">&gt;=</span> <span class="va">M0</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># select</span></span>
<span><span class="va">aquila</span> <span class="op">&lt;-</span> <span class="va">horus</span><span class="op">[</span><span class="va">aquila.sel</span>, <span class="op">]</span></span></code></pre></div>
<p>The data can be visually represented by plotting the time of each
event against the magnitude. This shows the clustering of the
observations in correspondance of high magnitude events.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">aquila</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">time_date</span>, <span class="va">M</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="tutorial_real_files/figure-html/unnamed-chunk-6-1.png" alt="L'Aquila seismic sequence, times versus magnitudes" width="700"><p class="caption">
Lâ€™Aquila seismic sequence, times versus magnitudes
</p>
</div>
</div>
<div class="section level2">
<h2 id="data-preparation-to-model-fitting">Data preparation to model fitting<a class="anchor" aria-label="anchor" href="#data-preparation-to-model-fitting"></a>
</h2>
<p>We need to prepare a <code>data.frame</code> to be used as input data
to fit the ETAS model. This <code>data.frame</code> must have three
columns: <code>ts</code> for the time difference between the starting
date and the occurrence time of the events (measured in days in this
example), <code>magnitudes</code> for the magnitude of the events, and
<code>idx.p</code> which is an index column with a different value for
each event. The names are fixed and should not be changed</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># set up data.frame for model fitting</span></span>
<span><span class="va">aquila.bru</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  ts <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/difftime.html" class="external-link">difftime</a></span><span class="op">(</span><span class="va">aquila</span><span class="op">$</span><span class="va">time_date</span>, <span class="va">start.date</span>,</span>
<span>    units <span class="op">=</span> <span class="st">"days"</span></span>
<span>  <span class="op">)</span><span class="op">)</span>,</span>
<span>  magnitudes <span class="op">=</span> <span class="va">aquila</span><span class="op">$</span><span class="va">M</span>,</span>
<span>  idx.p <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">aquila</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>After that, we need to set up the initial values of the parameters
and the <code>list</code> containing the <code>inlabru</code> options to
be used. The initial values should be stored in a <code>list</code> with
elements <code>th.mu</code>, <code>th.K</code>, <code>th.alpha</code>,
<code>th.c</code>, and <code>th.p</code> which corresponds to the ETAS
parameters. The initial values must be provided in the internal scale
and therefore it is useful to retrieve them using the inverse copula
transformations that we set up before. In this way, we can find the
values of the parameters in the internal scale given the value of the
parameters in the ETAS scale. The example below uses <span class="math inline">\(\mu = 0.5, K = 0.1, \alpha = 1, c = 0.1,\)</span>
and <span class="math inline">\(p = 1.1\)</span> as initial values. It
is crucial to set initial values that do not cause numerical problems,
in general this is achieved by setting initial values that are not nor
from zero. The values provided below have worked well in various
examples.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># set up list of initial values</span></span>
<span><span class="va">th.init</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  th.mu <span class="op">=</span> <span class="va">inv.link.f</span><span class="op">$</span><span class="fu">mu</span><span class="op">(</span><span class="fl">0.5</span><span class="op">)</span>,</span>
<span>  th.K <span class="op">=</span> <span class="va">inv.link.f</span><span class="op">$</span><span class="fu">K</span><span class="op">(</span><span class="fl">0.1</span><span class="op">)</span>,</span>
<span>  th.alpha <span class="op">=</span> <span class="va">inv.link.f</span><span class="op">$</span><span class="fu">alpha</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>,</span>
<span>  th.c <span class="op">=</span> <span class="va">inv.link.f</span><span class="op">$</span><span class="fu">c_</span><span class="op">(</span><span class="fl">0.1</span><span class="op">)</span>,</span>
<span>  th.p <span class="op">=</span> <span class="va">inv.link.f</span><span class="op">$</span><span class="fu">p</span><span class="op">(</span><span class="fl">1.1</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Lastly, we need to set the <code>list</code> of <code>inlabru</code>
options. The main elements of the <code>list</code> are :</p>
<ul>
<li>
<code>bru_verbose</code>: number indicating the type of diagnostic
output. Set it to 0 for no output.</li>
<li>
<code>bru_max_iter</code>: maximum number of iterations. If we do
not set <code>max_step</code> the <code>inlabru</code> algorithm stops
when the stopping criterion is met. However, setting
<code>max_step</code> to values smaller than 1 forces the algorithm to
run for exactly <code>bru_max_iter</code> iterations.</li>
<li>
<code>num.threads</code>: number of cores to be used in
parallel.</li>
<li>
<code>bru_method</code>: for what is relevant here, the only thing
that we may need to set is the <code>max_step</code> argument. If the
algorithm does not converge without fixing a <code>max_step</code> then
we suggest to try to fix it to some value below 1, in our experience
<span class="math inline">\(0.5\)</span> or <span class="math inline">\(0.2\)</span> works well. In the example below the
line setting <code>bru_method</code> is commented.</li>
<li>
<code>bru_initial</code>: <code>list</code> of initial values
created before.</li>
</ul>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># set up list of bru options</span></span>
<span><span class="va">bru.opt.list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  bru_verbose <span class="op">=</span> <span class="fl">3</span>, <span class="co"># type of visual output</span></span>
<span>  bru_max_iter <span class="op">=</span> <span class="fl">70</span>, <span class="co"># maximum number of iterations</span></span>
<span>  num.threads <span class="op">=</span> <span class="fl">2</span>, <span class="co"># Increase this if your computer has multiple cores</span></span>
<span>  <span class="co"># bru_method = list(max_step = 0.5),</span></span>
<span>  bru_initial <span class="op">=</span> <span class="va">th.init</span></span>
<span><span class="op">)</span> <span class="co"># parameters initial values</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="model-fitting">Model fitting<a class="anchor" aria-label="anchor" href="#model-fitting"></a>
</h2>
<p>The function <code>Temporal.ETAS</code> fit the ETAS model and
returns a <code>bru</code> object as output. The required inputs
are:</p>
<ul>
<li>
<code>total.data</code>: <code>data.frame</code> containing the
observed events. It have to be in the format described in the previous
Section.</li>
<li>
<code>M0</code>: cutoff magnitude. All the events in
<code>total.data</code> must have magnitude greater or equal to this
number.</li>
<li>
<code>T1</code>: starting time of the time interval on which we want
to fit the model.</li>
<li>
<code>T2</code>: end time of the time interval on which we want to
fit the model.</li>
<li>
<code>link.functions</code>: <code>list</code> of copula
transformation functions in the format described in previous
sections.</li>
<li>
<code>coef.t.</code>, <code>delta.t.</code>, <code>N.max.</code>:
parameters of the temporal binning. The binning strategy is described in
Appendix B of the paper <a href="https://onlinelibrary.wiley.com/doi/full/10.1002/env.2798" class="external-link">Approximation
of Bayesian Hawkes process with <code>inlabru</code></a>. The parameters
corresponds to <code>coef.t.</code><span class="math inline">\(=\delta\)</span>, <code>delta.t.</code><span class="math inline">\(=\Delta\)</span>, and <code>N.max.</code><span class="math inline">\(=n_{\max}\)</span>.</li>
<li>
<code>bru.opt</code>: <code>list</code> of <code>inlabru</code>
options as described in the previous Section.</li>
</ul>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># set starting and time of the time interval used for model fitting. In this case, we use the interval covered by the data.</span></span>
<span><span class="va">T1</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span><span class="va">T2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">aquila.bru</span><span class="op">$</span><span class="va">ts</span><span class="op">)</span> <span class="op">+</span> <span class="fl">0.2</span></span>
<span><span class="co"># fit the model</span></span>
<span><span class="va">aquila.fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Temporal.ETAS.html">Temporal.ETAS</a></span><span class="op">(</span></span>
<span>  total.data <span class="op">=</span> <span class="va">aquila.bru</span>,</span>
<span>  M0 <span class="op">=</span> <span class="va">M0</span>,</span>
<span>  T1 <span class="op">=</span> <span class="va">T1</span>,</span>
<span>  T2 <span class="op">=</span> <span class="va">T2</span>,</span>
<span>  link.functions <span class="op">=</span> <span class="va">link.f</span>,</span>
<span>  coef.t. <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  delta.t. <span class="op">=</span> <span class="fl">0.1</span>,</span>
<span>  N.max. <span class="op">=</span> <span class="fl">5</span>,</span>
<span>  bru.opt <span class="op">=</span> <span class="va">bru.opt.list</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Start creating grid... </span></span>
<span><span class="co">#&gt; Finished creating grid, time  2.575926</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="create-input-list">Create input list<a class="anchor" aria-label="anchor" href="#create-input-list"></a>
</h2>
<p>After a model has been fitted the package <code>ETAS.inlabru</code>
offers various functions to visually explore the output. They all
require in input a <code>list</code>. The <code>list</code> must have
different elements depending on the function we are going to use. To
retrieve the posterior of the parameters and to sample from the
posterior of the parameters we only need two elements:</p>
<ul>
<li>
<code>model.fit</code>: the output of
<code>Temporal.ETAS</code>
</li>
<li>
<code>link.functions</code>: the list of copula transformations</li>
</ul>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># create input list to explore model output</span></span>
<span><span class="va">input_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  model.fit <span class="op">=</span> <span class="va">aquila.fit</span>,</span>
<span>  link.functions <span class="op">=</span> <span class="va">link.f</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="check-marginal-posterior-distributions">Check marginal posterior distributions<a class="anchor" aria-label="anchor" href="#check-marginal-posterior-distributions"></a>
</h2>
<p>The function <code>get_posterior_param</code> can be use to retrieve
the marginal posteriors of the parameters in the ETAS scale. The
function returns a <code>list</code> with elements:</p>
<ul>
<li><p><code>post.df</code>: a <code>data.frame</code> containing the
posterior of the parameters. The <code>data.frame</code> has three
columns, <code>x</code> with the value of the parameter, <code>y</code>
with the corresponding value of the posterior, and <code>param</code>
that indicates which ETAS parameter <code>x</code> and <code>y</code>
are referring to.</p></li>
<li><p><code>post.plot</code>: a <code>ggplot</code> object containing
the plot of the marginal posteriors of the parameters</p></li>
</ul>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># get marginal posterior information</span></span>
<span><span class="va">post.list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_posterior_param.html">get_posterior_param</a></span><span class="op">(</span>input.list <span class="op">=</span> <span class="va">input_list</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># plot marginal posteriors</span></span>
<span><span class="va">post.list</span><span class="op">$</span><span class="va">post.plot</span></span></code></pre></div>
<p><img src="tutorial_real_files/figure-html/unnamed-chunk-12-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="sample-the-joint-posterior-and-make-pair-plot">Sample the joint posterior and make pair plot<a class="anchor" aria-label="anchor" href="#sample-the-joint-posterior-and-make-pair-plot"></a>
</h2>
<p>The function <code>post_sampling</code> generate samples from the
joint posterior of ETAS parameters. The function takes in input:</p>
<ul>
<li>
<code>input.list</code>: a list with a <code>model.fit</code>
element and a <code>link.functions</code> elements as described
above.</li>
<li>
<code>n.samp</code>: number of posterior samples.</li>
<li>
<code>max.batch</code>: the number of posterior samples to be
generated simultaneously. If <code>n.samp</code><span class="math inline">\(&gt;\)</span><code>max.batch</code>, then, the
samples are generated in parallel in batches of maximum size equal to
<code>max.batch</code>. Default is <span class="math inline">\(1000\)</span>.</li>
<li>
<code>ncore</code>: number of cores to be used in parallel when
<code>n.samp</code><span class="math inline">\(&gt;\)</span><code>max.batch</code>.</li>
</ul>
<p>The function returns a <code>data.frame</code> with columns
corresponding to the ETAS parameters</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">post.samp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/post_sampling.html">post_sampling</a></span><span class="op">(</span></span>
<span>  input.list <span class="op">=</span> <span class="va">input_list</span>,</span>
<span>  n.samp <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>  max.batch <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>  ncore <span class="op">=</span> <span class="fl">1</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">post.samp</span><span class="op">)</span></span>
<span><span class="co">#&gt;          mu         K    alpha          c        p</span></span>
<span><span class="co">#&gt; 1 0.3677738 0.1617029 2.425827 0.05822018 1.157604</span></span>
<span><span class="co">#&gt; 2 0.3445203 0.1262370 2.395503 0.09943504 1.239542</span></span>
<span><span class="co">#&gt; 3 0.2833900 0.1600875 2.408921 0.06421593 1.175880</span></span>
<span><span class="co">#&gt; 4 0.3042535 0.1205547 2.475632 0.07013789 1.171228</span></span>
<span><span class="co">#&gt; 5 0.3017681 0.1260403 2.456525 0.06481491 1.151355</span></span>
<span><span class="co">#&gt; 6 0.2927550 0.1327959 2.444883 0.07093366 1.198998</span></span></code></pre></div>
<p>The posterior samples can be used to analyse the correlation between
parameters. The function <code>post_pairs_plot</code> generate a pair
plot of the posterior samples taken as input. The function has 4
arguments but they do not need to be all specified. The input are:</p>
<ul>
<li>
<code>post.samp</code>: <code>data.frame</code> of samples from the
joint posterior distribution of the parameters. If it is
<code>NULL</code> than the samples are generated by the function
itself.</li>
<li>
<code>input.list</code>: an input list with arguments
<code>model.fit</code> and <code>link.functions</code> to be used to
generate the posterior samples. This is used only if
<code>post.samp = NULL</code>. Default is <code>NULL</code>.</li>
<li>
<code>n.samp</code>: number of posterior samples. If it is
<code>NULL</code>, then the samples in <code>post.samp</code> are used.
If <code>post.samp</code> is <code>NULL</code>, then <code>n.samp</code>
samples are generated from the joint posterior. If both
<code>post.samp</code> and <code>n.samp</code> are not <code>NULL</code>
then <code>n.samp</code> samples are randomly (uniformly and with
replacement) selected from <code>post.samp</code>. Default is
<code>NULL</code>
</li>
<li>
<code>max.batch</code> the number of posterior samples to be
generated simultaneously. Same as before and only used when
<code>post.samp</code> is NULL. Default is <code>NULL</code>
</li>
</ul>
<p>The function returns a <code>list</code> with two elements:
<code>post.samp</code> with the posterior samples, and
<code>pair.plot</code> which is a <code>ggplot</code> object containing
the pair plot.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pair.plot</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/post_pairs_plot.html">post_pairs_plot</a></span><span class="op">(</span></span>
<span>  post.samp <span class="op">=</span> <span class="va">post.samp</span>,</span>
<span>  input.list <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  n.samp <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  max.batch <span class="op">=</span> <span class="fl">1000</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Registered S3 method overwritten by 'GGally':</span></span>
<span><span class="co">#&gt;   method from   </span></span>
<span><span class="co">#&gt;   +.gg   ggplot2</span></span>
<span><span class="va">pair.plot</span><span class="op">$</span><span class="va">pair.plot</span></span></code></pre></div>
<p><img src="tutorial_real_files/figure-html/unnamed-chunk-14-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="check-posterior-number-of-events">Check posterior number of events<a class="anchor" aria-label="anchor" href="#check-posterior-number-of-events"></a>
</h2>
<p>A quantity of interest is the posterior distribution of the number of
events. This can be accessed using the function
<code>get_posterior_N</code> which requires as only input a
<code>list</code>. However, the <code>list</code> needs to have some
additional elements with respect the one used until now. Specifically,
we need to add <code>T12</code> with the extremes of the time interval
of which we want to calculate the number of events, <code>M0</code> the
cutoff magnitude, and <code>catalog.bru</code> a <code>data.frame</code>
containing the observed events. The latter has to be in the same format
as <code>total.data</code> used for the <code>Temporal.ETAS</code>
function.</p>
<p>The function returns a list of three elements: <code>post.plot</code>
with a plot of the distribution, <code>post.plot.shaded</code> with a
plot of the distribution with shaded regions representing <span class="math inline">\(95\%\)</span> interval for the distribution, and
<code>post.df</code> with the <code>data.frame</code> used to generate
the plots. The vertical line in the plots represent the number of events
in the <code>catalog.bru</code> element of the input list.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># set additional elements of the list</span></span>
<span><span class="va">input_list</span><span class="op">$</span><span class="va">T12</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">T1</span>, <span class="va">T2</span><span class="op">)</span></span>
<span><span class="va">input_list</span><span class="op">$</span><span class="va">M0</span> <span class="op">&lt;-</span> <span class="va">M0</span></span>
<span><span class="va">input_list</span><span class="op">$</span><span class="va">catalog.bru</span> <span class="op">&lt;-</span> <span class="va">aquila.bru</span></span></code></pre></div>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">N.post</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_posterior_N.html">get_posterior_N</a></span><span class="op">(</span>input.list <span class="op">=</span> <span class="va">input_list</span><span class="op">)</span></span>
<span><span class="va">N.post</span><span class="op">$</span><span class="va">post.plot</span></span></code></pre></div>
<p><img src="tutorial_real_files/figure-html/unnamed-chunk-16-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="posterior-of-the-triggering-function-and-omori-law">Posterior of the triggering function and Omori law<a class="anchor" aria-label="anchor" href="#posterior-of-the-triggering-function-and-omori-law"></a>
</h2>
<p>The functions <code>triggering_fun_plot</code> and
<code>triggering_fun_plot_prior</code> plot, respectively, the quantiles
of the posterior and prior distribution of the triggering function <span class="math inline">\(g(t-t_h, mh)\)</span>, namely,</p>
<p><span class="math display">\[
g(t - t_h, m_h) = K\exp\{\alpha(m_h - M_0)\}\left(\frac{t - t_h}{c} +
1\right)^{-p}
\]</span> The function takes in input</p>
<ul>
<li>
<code>input.list</code>: the input list as defined for the functions
used previously.</li>
<li>
<code>post.samp</code>: a <code>data.frame</code> of samples from
the posterior distribution of the parameters. If it is
<code>NULL</code>, then <code>n.samp</code> samples are generated from
the posterior.</li>
<li>
<code>n.samp</code>: number of posterior samples of the parameters
to be used or generated.</li>
<li>
<code>magnitude</code>: the magnitude of the event (<span class="math inline">\(m_h\)</span>).</li>
<li>
<code>t.end</code>: the maximum value of <span class="math inline">\(t\)</span> for the plot.</li>
<li>
<code>n.breaks</code>: the number of breaks in which the interval
<span class="math inline">\((0, \texttt{t.end})\)</span> is
divided.</li>
</ul>
<p>The function returns a <code>ggplot</code> object. For each sample of
the parameters the triggering function between <span class="math inline">\(0\)</span> and <code>t.end</code> is calculated.
The black solid lines represents the <span class="math inline">\(95\%\)</span> posterior interval of the function,
the grey lines represent the triggering function calculated with the
posterior samples, and the horizontal red lines represent the <span class="math inline">\(95\%\)</span> posterior interval of the background
rate <span class="math inline">\(\mu\)</span>.</p>
<p>The function <code>triggering_fun_plot_prior</code> does the same but
the value of the parameters are sampled according to the prior
distribution rather than the posterior, and therefore, we do not need to
specify a posterior samples <code>data.frame</code>.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/triggering_fun_plot.html">triggering_fun_plot</a></span><span class="op">(</span></span>
<span>  input.list <span class="op">=</span> <span class="va">input_list</span>,</span>
<span>  post.samp <span class="op">=</span> <span class="va">post.samp</span>,</span>
<span>  n.samp <span class="op">=</span> <span class="cn">NULL</span>, magnitude <span class="op">=</span> <span class="fl">4</span>,</span>
<span>  t.end <span class="op">=</span> <span class="fl">5</span>, n.breaks <span class="op">=</span> <span class="fl">100</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="tutorial_real_files/figure-html/unnamed-chunk-17-1.png" width="700"></p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/triggering_fun_plot_prior.html">triggering_fun_plot_prior</a></span><span class="op">(</span>input.list <span class="op">=</span> <span class="va">input_list</span>, magnitude <span class="op">=</span> <span class="fl">4</span>, n.samp <span class="op">=</span> <span class="fl">1000</span>, t.end <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span></code></pre></div>
<p><img src="tutorial_real_files/figure-html/unnamed-chunk-18-1.png" width="700"></p>
<p>The functions <code>omori_plot_posterior</code> and
<code>omori_plot_prior</code> do the same as the functions
<code>triggering_fun_plot</code> and
<code>triggering_fun_plot_prior</code> but considering only</p>
<p><span class="math display">\[
\left(\frac{t- t_h}{c} + 1\right)^{-p}
\]</span> instead of the whole triggering function and without the
background rate.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/omori_plot_posterior.html">omori_plot_posterior</a></span><span class="op">(</span>input.list <span class="op">=</span> <span class="va">input_list</span>, post.samp <span class="op">=</span> <span class="va">post.samp</span>, n.samp <span class="op">=</span> <span class="cn">NULL</span>, t.end <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span></code></pre></div>
<p><img src="tutorial_real_files/figure-html/unnamed-chunk-19-1.png" width="700"></p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/omori_plot_prior.html">omori_plot_prior</a></span><span class="op">(</span>input.list <span class="op">=</span> <span class="va">input_list</span>, n.samp <span class="op">=</span> <span class="fl">1000</span>, t.end <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span></code></pre></div>
<p><img src="tutorial_real_files/figure-html/unnamed-chunk-20-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="generate-synthetic-catalogues-from-model">Generate synthetic catalogues from model<a class="anchor" aria-label="anchor" href="#generate-synthetic-catalogues-from-model"></a>
</h2>
<p>An earthquake forecast is usually composed by a collection of
synthetic catalogues from a model. The package <code>ETAS.inlabru</code>
provides a function to generate synthetic catalogues for a given set of
parameters. This can be used both to produce forecasts or to simply
produce synthetic catalogues. The function to generate synthetic
catalogues is called <code>generate_temporal_ETAS_synthetic</code> which
takes as input</p>
<ul>
<li>
<code>theta</code>: a <code>list</code> of ETAS parameters with
names <code>mu</code>, <code>K</code>, <code>alpha</code>,
<code>c</code>, and <code>p</code>, corresponding to the ETAS
parameters.</li>
<li>
<code>beta.p</code>: the parameter of the magnitude
distribution</li>
<li>
<code>M0</code>: cutoff magnitude, all the generated event will have
magnitude greater than <code>M0</code>.</li>
<li>
<code>T1</code>: starting time of the catalogue (the unit of measure
depends on the unit used to fit the model).</li>
<li>
<code>T2</code>: end time of the catalogue (the unit of measure
depends on the unit used to fit the model).</li>
<li>
<code>Ht</code>: set of known events. They can also be between
<code>T1</code> and <code>T2</code>, this is useful when we want to
generate catalogues with imposed events.</li>
</ul>
<p>Regarding the magnitude distribution, it is an exponential,
specificically we assume</p>
<p><span class="math display">\[
m - M_0 \sim \text{Exp}(\beta)
\]</span> The parameter <span class="math inline">\(\beta\)</span> is
usually estimated independently from the ETAS parameters. We use the
maximum likelihood estimator for <span class="math inline">\(\beta\)</span> which is given by</p>
<p><span class="math display">\[
\hat\beta = \frac{1}{\bar{m} - M_0}
\]</span> where <span class="math inline">\(\bar m\)</span> is the mean
of the observed magnitudes values.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># maximum likelihood estimator for beta</span></span>
<span><span class="va">beta.p</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">/</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">aquila.bru</span><span class="op">$</span><span class="va">magnitudes</span><span class="op">)</span> <span class="op">-</span> <span class="va">M0</span><span class="op">)</span></span></code></pre></div>
<p>The function returns a <code>list</code> of <code>data.frame</code>,
each element of the output <code>list</code> corresponds to a different
generation. The <code>data.frame</code> have three columns: occurence
time (<code>ts</code>), magnitude (<code>magnitudes</code>), a the
generation identifier (<code>gen</code>). The generation identifier uses
the following convention, <span class="math inline">\(-1\)</span>
indicates the events in <code>Ht</code> with time between
<code>T1</code> and <code>T2</code>, <span class="math inline">\(0\)</span> indicates the first generation
offspring of the events with <code>gen</code> equal <span class="math inline">\(-1\)</span>, <span class="math inline">\(1\)</span> indicates background events, <span class="math inline">\(2\)</span> all the offspring of the events with
<code>gen</code> equal <span class="math inline">\(0\)</span> or <span class="math inline">\(1\)</span>, <span class="math inline">\(3\)</span>
indicates all the offspring of the events with <code>gen</code> equal
<span class="math inline">\(2\)</span>, <span class="math inline">\(4\)</span> indicates all the offspring of the
events with <code>gen</code> equal <span class="math inline">\(3\)</span>, and so on. To obtain a unique
<code>data.frame</code> containing all the simulated events it is
sufficient to bind by rows all the generations.</p>
<p>Below an example in which we generate 1 synthetic catalogue using as
parameters one of the posterior samples generated before. The catalogue
covers the same time span as the Lâ€™Aquila catalogue and we impose the
greatest event in the sequence.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">synth.cat.list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generate_temporal_ETAS_synthetic.html">generate_temporal_ETAS_synthetic</a></span><span class="op">(</span></span>
<span>  theta <span class="op">=</span> <span class="va">post.samp</span><span class="op">[</span><span class="fl">1</span>, <span class="op">]</span>, <span class="co"># ETAS parameters</span></span>
<span>  beta.p <span class="op">=</span> <span class="va">beta.p</span>, <span class="co"># magnitude distribution parameter</span></span>
<span>  M0 <span class="op">=</span> <span class="va">M0</span>, <span class="co"># cutoff magnitude</span></span>
<span>  T1 <span class="op">=</span> <span class="va">T1</span>, <span class="co"># starting time</span></span>
<span>  T2 <span class="op">=</span> <span class="va">T2</span>, <span class="co"># end time</span></span>
<span>  Ht <span class="op">=</span> <span class="va">aquila.bru</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.min.html" class="external-link">which.max</a></span><span class="op">(</span><span class="va">aquila.bru</span><span class="op">$</span><span class="va">magnitudes</span><span class="op">)</span>, <span class="op">]</span> <span class="co"># known events</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># merge into unique data.frame</span></span>
<span><span class="va">synth.cat.df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="va">synth.cat.list</span><span class="op">)</span></span>
<span><span class="co"># order events by time</span></span>
<span><span class="va">synth.cat.df</span> <span class="op">&lt;-</span> <span class="va">synth.cat.df</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">synth.cat.df</span><span class="op">$</span><span class="va">ts</span><span class="op">)</span>, <span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">synth.cat.df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">ts</span>, <span class="va">magnitudes</span>, color <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">gen</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span></code></pre></div>
<p><img src="tutorial_real_files/figure-html/unnamed-chunk-22-1.png" width="700"></p>
<p>We can easily generate multiple catalogues. The code below generates
8 catalogues using different samples from the posterior distribution of
the parameters. The red point indicates the event that we have imposed
and the last panel represents the observed Lâ€™Aquila sequence.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">n.cat</span> <span class="op">&lt;-</span> <span class="fl">8</span></span>
<span><span class="co"># generate catalogues as list of lists</span></span>
<span><span class="va">multi.synth.cat.list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">n.cat</span><span class="op">)</span>, \<span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/generate_temporal_ETAS_synthetic.html">generate_temporal_ETAS_synthetic</a></span><span class="op">(</span></span>
<span>  theta <span class="op">=</span> <span class="va">post.samp</span><span class="op">[</span><span class="va">x</span>, <span class="op">]</span>,</span>
<span>  beta.p <span class="op">=</span> <span class="va">beta.p</span>,</span>
<span>  M0 <span class="op">=</span> <span class="va">M0</span>,</span>
<span>  T1 <span class="op">=</span> <span class="va">T1</span>,</span>
<span>  T2 <span class="op">=</span> <span class="va">T2</span>,</span>
<span>  Ht <span class="op">=</span> <span class="va">aquila.bru</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.min.html" class="external-link">which.max</a></span><span class="op">(</span><span class="va">aquila.bru</span><span class="op">$</span><span class="va">magnitudes</span><span class="op">)</span>, <span class="op">]</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># store catalogues as list of data.frames</span></span>
<span><span class="va">multi.synth.cat.list.df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">multi.synth.cat.list</span>, \<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># set catalogue identifier</span></span>
<span><span class="va">multi.synth.cat.list.df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">n.cat</span><span class="op">)</span>, \<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">multi.synth.cat.list.df</span><span class="op">[[</span><span class="va">x</span><span class="op">]</span><span class="op">]</span>,</span>
<span>  cat.idx <span class="op">=</span> <span class="va">x</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># merge catalogues in unique data.frame</span></span>
<span><span class="va">multi.synth.cat.df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="va">multi.synth.cat.list.df</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># we need to bing the synthetics with the observed catalogue for plotting</span></span>
<span><span class="va">cat.df.for.plotting</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span></span>
<span>  <span class="va">multi.synth.cat.df</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">aquila.bru</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ts"</span>, <span class="st">"magnitudes"</span><span class="op">)</span><span class="op">]</span>,</span>
<span>    gen <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>    cat.idx <span class="op">=</span> <span class="st">"observed"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># plot them</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">cat.df.for.plotting</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">ts</span>, <span class="va">magnitudes</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">aquila.bru</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.min.html" class="external-link">which.max</a></span><span class="op">(</span><span class="va">aquila.bru</span><span class="op">$</span><span class="va">magnitudes</span><span class="op">)</span>, <span class="op">]</span>,</span>
<span>    mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">ts</span>, <span class="va">magnitudes</span><span class="op">)</span>,</span>
<span>    color <span class="op">=</span> <span class="st">"red"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span>facets <span class="op">=</span> <span class="op">~</span><span class="va">cat.idx</span><span class="op">)</span></span></code></pre></div>
<p><img src="tutorial_real_files/figure-html/unnamed-chunk-23-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="forecasting">Forecasting<a class="anchor" aria-label="anchor" href="#forecasting"></a>
</h2>
<p>An earthquake forecast is usually collection of synthetic catalogues
generated from a model. For bayesian models we can reflect the
uncertainty on the parameters values by generating each synthetic
catalogue composing the forecast using a different set of parameters
sampled from the join posterior distribution. We can generate forecasts
using the function <code>Temporal.ETAS.forecast</code>. The function
takes as input</p>
<ul>
<li>
<code>post.samp</code>: a <code>data.frame</code> of samples from
the posterior distribution of the parameters with the same format
described in previous sections.</li>
<li>
<code>n.cat</code>: the number of synthetic catalogues composing the
forecast. If <code>n.cat</code> is greater than
<code>nrow(post.samp)</code>, then the rows of <code>post.samp</code>
are sampled uniformly and with replacement <code>n.cat</code> times. If
<code>n.cat</code> is smaller than <code>nrow(post.samp)</code>, then,
then the rows of <code>post.samp</code> are sampled uniformly and
without replacement <code>n.cat</code> times. If <code>n.cat</code> is
<code>NULL</code> or equal to <code>nrow(post.samp)</code>, then,
<code>post.samp</code> is used as it is.</li>
<li>
<code>ncore</code>: the number of cores to be used to generate the
synthetic catalogues in parallel.</li>
</ul>
<p>The remaining inputs (<code>beta.p</code>, <code>M0</code>,
<code>T1</code>, <code>T2</code>, <code>Ht</code>) are the same as the
ones used in <code>generate_temporal_ETAS_synthetic</code>.</p>
<p>The output of the function is a <code>list</code> with two elements:
<code>fore.df</code> and <code>n.cat</code>. The element
<code>fore.df</code> is a <code>data.frame</code> with the synthetic
catalogues binded together by row, it is the same as
<code>multi.synth.cat.df</code> created before. The element
<code>n.cat</code> is just the number of catalogues generated. We need
<code>n.cat</code> because zero-events catalogues do not appear in
<code>fore.df</code>, and the corresponding <code>cat.idx</code> value
is missing. Therefore we need <code>n.cat</code> to recover the total
number of catalogues.</p>
<p>The code below creates a daily forecast for the 24 hours starting 1
minute after the event with the greatest magnitude in the sequence. The
starting date and end date of the forecast are expressed in the same
unit used in the catalogue to fit the model (days in this case). Day
zero correspond to <code>start.date</code> stated in the beginning of
the document which for the example is <span class="math inline">\(2009-01-01 00:00:00\)</span>. The forecast is
generated assuming known all the events in the catalogue occurred before
the forecasting period.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># express 1 minute in days</span></span>
<span><span class="va">min.in.days</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">/</span> <span class="op">(</span><span class="fl">24</span> <span class="op">*</span> <span class="fl">60</span><span class="op">)</span></span>
<span><span class="co"># find time of the event with the greatest magnitude</span></span>
<span><span class="va">t.max.mag</span> <span class="op">&lt;-</span> <span class="va">aquila.bru</span><span class="op">$</span><span class="va">ts</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.min.html" class="external-link">which.max</a></span><span class="op">(</span><span class="va">aquila.bru</span><span class="op">$</span><span class="va">magnitudes</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="co"># set starting time of the forecasting period</span></span>
<span><span class="va">T1.fore</span> <span class="op">&lt;-</span> <span class="va">t.max.mag</span> <span class="op">+</span> <span class="va">min.in.days</span></span>
<span><span class="co"># set forecast length</span></span>
<span><span class="va">fore.length</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="co"># set end time of the forecasting period</span></span>
<span><span class="va">T2.fore</span> <span class="op">&lt;-</span> <span class="va">T1.fore</span> <span class="op">+</span> <span class="va">fore.length</span></span>
<span><span class="co"># set known data</span></span>
<span><span class="va">Ht.fore</span> <span class="op">&lt;-</span> <span class="va">aquila.bru</span><span class="op">[</span><span class="va">aquila.bru</span><span class="op">$</span><span class="va">ts</span> <span class="op">&lt;</span> <span class="va">T1.fore</span>, <span class="op">]</span></span>
<span></span>
<span><span class="co"># produce forecast</span></span>
<span><span class="va">daily.fore</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Temporal.ETAS.forecast.html">Temporal.ETAS.forecast</a></span><span class="op">(</span></span>
<span>  post.samp <span class="op">=</span> <span class="va">post.samp</span>, <span class="co"># ETAS parameters posterior samples</span></span>
<span>  n.cat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">post.samp</span><span class="op">)</span>, <span class="co"># number of synthetic catalogues</span></span>
<span>  beta.p <span class="op">=</span> <span class="va">beta.p</span>, <span class="co"># magnitude distribution parameter</span></span>
<span>  M0 <span class="op">=</span> <span class="va">M0</span>, <span class="co"># cutoff magnitude</span></span>
<span>  T1 <span class="op">=</span> <span class="va">T1.fore</span>, <span class="co"># forecast starting time</span></span>
<span>  T2 <span class="op">=</span> <span class="va">T2.fore</span>, <span class="co"># forecast end time</span></span>
<span>  Ht <span class="op">=</span> <span class="va">Ht.fore</span>, <span class="co"># known events</span></span>
<span>  ncore <span class="op">=</span> <span class="fl">3</span></span>
<span><span class="op">)</span> <span class="co"># number of cores</span></span></code></pre></div>
<p>We can easily retrieve the predictive distribution of the number of
events in the forecasting period looking at the frequencies with which
the catalogue identifiers appears in the <code>fore.df</code> element.
Indeed, the number of rows of <code>fore.df</code> with the same
<code>cat.idx</code> value represents the number of events in that
synthetic catalogue. So, if the frequency with which each catalogue
identifier appears in <code>fore.df$cat.idx</code> correspond to the
number of events in that catalogue. This allows to easily retrieve the
predictive distribution of the number of events using the code below. We
remark that in this case we can not use the function <code>table</code>
to find the frequencies of elements of <code>fore.df$cat.idx</code>.
This is because the catalogue identifier of zero-events catalogues are
not present in <code>fore.df$cat.idx</code>. So using <code>table</code>
would lead to have zero probability of having zero events in a day,
quantity that is crucial if we are intersted in the probability of
earthquake activity (probability of having at least one event).</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># find number of events per catalogue</span></span>
<span><span class="va">N.fore</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">vapply</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">daily.fore</span><span class="op">$</span><span class="va">n.cat</span><span class="op">)</span>,</span>
<span>  \<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">daily.fore</span><span class="op">$</span><span class="va">fore.df</span><span class="op">$</span><span class="va">cat.idx</span> <span class="op">==</span> <span class="va">x</span><span class="op">)</span>, <span class="fl">0</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># find number of observed events in the forecasting period</span></span>
<span><span class="va">N.obs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">aquila.bru</span><span class="op">$</span><span class="va">ts</span> <span class="op">&gt;=</span> <span class="va">T1.fore</span> <span class="op">&amp;</span> <span class="va">aquila.bru</span><span class="op">$</span><span class="va">ts</span> <span class="op">&lt;=</span> <span class="va">T2.fore</span><span class="op">)</span></span>
<span><span class="co"># plot the distribution</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html" class="external-link">geom_histogram</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">N.fore</span>, y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes_eval.html" class="external-link">after_stat</a></span><span class="op">(</span><span class="va">density</span><span class="op">)</span><span class="op">)</span>, binwidth <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="va">N.obs</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">xlim</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">500</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Removed 28 rows containing non-finite values (`stat_bin()`).</span></span>
<span><span class="co">#&gt; Warning: Removed 2 rows containing missing values (`geom_bar()`).</span></span></code></pre></div>
<p><img src="tutorial_real_files/figure-html/unnamed-chunk-25-1.png" width="700"></p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Francesco Serafini, Mark Naylor, Finn Lindgren.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
