<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="ETAS.inlabru">
<title>Tutorial on synthetic data â€¢ ETAS.inlabru</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Tutorial on synthetic data">
<meta property="og:description" content="ETAS.inlabru">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">ETAS.inlabru</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.1.0.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/generateSyntheticCatalogues.html">Generating synthetic temporal ETAS catalogues</a>
    <a class="dropdown-item" href="../articles/sensitivityToStartingPoint.html">Sensitivity to starting point</a>
    <a class="dropdown-item" href="../articles/tutorial_real.html">Tutorial on real data</a>
    <a class="dropdown-item" href="../articles/tutorial_synth.html">Tutorial on synthetic data</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/edinburgh-seismicity-hub/ETAS.inlabru/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Tutorial on synthetic data</h1>
                        <h4 data-toc-skip class="author">Francesco
Serafini</h4>
            
            <h4 data-toc-skip class="date">2023-06-29</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/edinburgh-seismicity-hub/ETAS.inlabru/blob/HEAD/vignettes/articles/tutorial_synth.Rmd" class="external-link"><code>vignettes/articles/tutorial_synth.Rmd</code></a></small>
      <div class="d-none name"><code>tutorial_synth.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://edinburgh-seismicity-hub.github.io/ETAS.inlabru/">ETAS.inlabru</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Increase num.threads if you have more cores on your computer</span></span>
<span><span class="fu">INLA</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/INLA/man/options.html" class="external-link">inla.setOption</a></span><span class="op">(</span>num.threads <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This tutorial shows how to use the <code>ETAS.inlabru</code> package
to generate a synthetic catalogue from a temporal ETAS model and how to
fit an ETAS model on this data. We also show how to retrieve the
posterior distribution of the parameters and other quantity of
interest.</p>
<p>For a brief introduction to the ETAS model we refer to the tutorial
on real earthquake data.</p>
</div>
<div class="section level2">
<h2 id="generate-a-synthetic-catalogue">Generate a synthetic catalogue<a class="anchor" aria-label="anchor" href="#generate-a-synthetic-catalogue"></a>
</h2>
<p>The function <code><a href="../reference/generate_temporal_ETAS_synthetic.html">generate_temporal_ETAS_synthetic()</a></code> can be
used to generate synthetic catalogues from a temporal ETAS model with
fixed parameters spanning a given interval of time. The
<code><a href="../reference/generate_temporal_ETAS_synthetic.html">generate_temporal_ETAS_synthetic()</a></code> takes as input</p>
<ul>
<li>
<code>theta</code>: a <code>list</code> of ETAS parameters with
names <code>mu</code>, <code>K</code>, <code>alpha</code>,
<code>c</code>, and <code>p</code>, corresponding to the ETAS
parameters.</li>
<li>
<code>beta.p</code>: the parameter of the magnitude
distribution</li>
<li>
<code>M0</code>: cutoff magnitude, all the generated event will have
magnitude greater than <code>M0</code>.</li>
<li>
<code>T1</code>: starting time of the catalogue (the unit of measure
depends on the unit used to fit the model).</li>
<li>
<code>T2</code>: end time of the catalogue (the unit of measure
depends on the unit used to fit the model).</li>
<li>
<code>Ht</code>: set of known events. They can also be between
<code>T1</code> and <code>T2</code>, this is useful when we want to
generate catalogues with imposed events. If it is <code>NULL</code> no
events are imposed.</li>
</ul>
<p>The function returns a <code>list</code> of <code>data.frame</code>,
each element of the output <code>list</code> corresponds to a different
generation. The <code>data.frame</code> have three columns: occurence
time (<code>ts</code>), magnitude (<code>magnitudes</code>), a the
generation identifier (<code>gen</code>). The generation identifier uses
the following convention, <span class="math inline">\(-1\)</span>
indicates the events in <code>Ht</code> with time between
<code>T1</code> and <code>T2</code>, <span class="math inline">\(0\)</span> indicates the first generation
offspring of the events with <code>gen</code> equal <span class="math inline">\(-1\)</span>, <span class="math inline">\(1\)</span> indicates background events, <span class="math inline">\(2\)</span> all the offspring of the events with
<code>gen</code> equal <span class="math inline">\(0\)</span> or <span class="math inline">\(1\)</span>, <span class="math inline">\(3\)</span>
indicates all the offspring of the events with <code>gen</code> equal
<span class="math inline">\(2\)</span>, <span class="math inline">\(4\)</span> indicates all the offspring of the
events with <code>gen</code> equal <span class="math inline">\(3\)</span>, and so on. To obtain a unique
<code>data.frame</code> containing all the simulated events it is
sufficient to bind by rows all the generations.</p>
<p>The code below generates a synthetic catalogue of events with
magnitude greater than <span class="math inline">\(2.5\)</span>
according to a temporal ETAS model with parameters equal to the vector
<code>true.param</code>. The value of the parameters is equal to the
posterior mean of the parameters obtained fitting a model on the
Lâ€™Aquila seismic sequence as it is done in the tutorial on real data.
Also the parameter <span class="math inline">\(\beta\)</span> of the
magnitude distribution comes from the same example.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">111</span><span class="op">)</span></span>
<span><span class="co"># set true ETAS parameters</span></span>
<span><span class="va">true.param</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>mu <span class="op">=</span> <span class="fl">0.30106014</span>, K <span class="op">=</span> <span class="fl">0.13611399</span>, alpha <span class="op">=</span> <span class="fl">2.43945301</span>, c <span class="op">=</span> <span class="fl">0.07098607</span>, p <span class="op">=</span> <span class="fl">1.17838741</span><span class="op">)</span></span>
<span><span class="co"># set magnitude distribution parameter</span></span>
<span><span class="va">beta.p</span> <span class="op">&lt;-</span> <span class="fl">2.353157</span></span>
<span><span class="co"># set cutoff magnitude</span></span>
<span><span class="va">M0</span> <span class="op">&lt;-</span> <span class="fl">2.5</span></span>
<span><span class="co"># set starting time of the synthetic catalogue</span></span>
<span><span class="va">T1</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span><span class="co"># set end time of the synthetic catalogue</span></span>
<span><span class="va">T2</span> <span class="op">&lt;-</span> <span class="fl">365</span></span>
<span><span class="co"># generate the catalogue - it returns a list of data.frames</span></span>
<span><span class="va">synth.cat.list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generate_temporal_ETAS_synthetic.html">generate_temporal_ETAS_synthetic</a></span><span class="op">(</span></span>
<span>  theta <span class="op">=</span> <span class="va">true.param</span>,</span>
<span>  beta.p <span class="op">=</span> <span class="va">beta.p</span>,</span>
<span>  M0 <span class="op">=</span> <span class="va">M0</span>,</span>
<span>  T1 <span class="op">=</span> <span class="va">T1</span>,</span>
<span>  T2 <span class="op">=</span> <span class="va">T2</span>,</span>
<span>  Ht <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  ncore <span class="op">=</span> <span class="fl">1</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The output of the function is a <code>list</code> of
<code>data.frame</code>s and it is convenient to transform it in a
single <code>data.frame</code> binding the rows of the
<code>data.frame</code>s in the list.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">synth.cat.df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="va">synth.cat.list</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">synth.cat.df</span><span class="op">)</span></span>
<span><span class="co">#&gt;           ts magnitudes gen</span></span>
<span><span class="co">#&gt; 1 135.204031   2.661688   1</span></span>
<span><span class="co">#&gt; 2 187.947198   2.632073   1</span></span>
<span><span class="co">#&gt; 3 137.847074   3.073890   1</span></span>
<span><span class="co">#&gt; 4 152.693124   2.653628   1</span></span>
<span><span class="co">#&gt; 5   3.890113   2.686633   1</span></span>
<span><span class="co">#&gt; 6 194.287763   3.035756   1</span></span></code></pre></div>
<p>The synthetic catalogue is composed by a total of <span class="math inline">\(288\)</span> events of which <span class="math inline">\(112\)</span> are background events and <span class="math inline">\(176\)</span> are aftershocks. We can easily
retrieve this numbers looking at the <code>gen</code> column of the
data.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>N <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">synth.cat.df</span><span class="op">)</span>, N.bkg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">synth.cat.df</span><span class="op">$</span><span class="va">gen</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span>, N.after <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">synth.cat.df</span><span class="op">$</span><span class="va">gen</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;       N   N.bkg N.after </span></span>
<span><span class="co">#&gt;     288     112     176</span></span></code></pre></div>
<p>The code below is to plot the occurrence time of the events against
their magnitude with color indicating the generation of each event and
the time evolution cumulative number of events. The
<code>multiplot</code> function provided by the <code>inlabru</code>
R-package can be used to combine the plots.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pl1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">synth.cat.df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">ts</span>, <span class="va">magnitudes</span>, color <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">gen</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"gen"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">t.breaks</span> <span class="op">&lt;-</span> <span class="va">T1</span><span class="op">:</span><span class="va">T2</span></span>
<span><span class="va">N.cumsum</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">vapply</a></span><span class="op">(</span><span class="va">t.breaks</span>, \<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">synth.cat.df</span><span class="op">$</span><span class="va">ts</span> <span class="op">&lt;</span> <span class="va">x</span><span class="op">)</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">df.to.cumsum.plot</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>ts <span class="op">=</span> <span class="va">t.breaks</span>, N.cum <span class="op">=</span> <span class="va">N.cumsum</span><span class="op">)</span></span>
<span><span class="va">pl2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">df.to.cumsum.plot</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">ts</span>, <span class="va">N.cum</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"cumulative number of events"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">inlabru</span><span class="fu">::</span><span class="fu"><a href="https://inlabru-org.github.io/inlabru/reference/multiplot.html" class="external-link">multiplot</a></span><span class="op">(</span><span class="va">pl1</span>, <span class="va">pl2</span>, cols <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p><img src="tutorial_synth_files/figure-html/unnamed-chunk-4-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="prepare-data-for-model-fitting">Prepare data for model fitting<a class="anchor" aria-label="anchor" href="#prepare-data-for-model-fitting"></a>
</h2>
<p>In order to fit a model on the synthetic catalogue we need to</p>
<ol style="list-style-type: decimal">
<li>set parameters priors</li>
<li>set initial value of the parameters</li>
<li>set <code>inlabru</code> options</li>
<li>prepare the data for model fitting</li>
</ol>
<p>To set the priors we need to create a list of copula transformation
(or simply link) functions. This is because our method works with an
internal representation of the parameters in which each parameter has a
Gaussian distribution. We need the function to transform the parameters
in the original ETAS scale and to set a prior for them. The
<code>ETAS.inlabru</code> package offers four different functions
corresponding to four different prior distributions. The functions are
<code>gamma_t</code>, <code>unif_t</code>, <code>exp_t</code>,
<code>loggaus_t</code> which corresponds to a Gamma distribution, a
Uniform distribution, an Exponential distribution and a Log-Gaussian
distribution. We also provide the inverse of this functions to retrieve
the value of the parameters in the internal scale given a value in the
ETAS scale. These are <code>inv_gamma_t</code>, <code>inv_unif_t</code>,
<code>exp_t</code>, and <code>inv_loggaus_t</code>.</p>
<p>For this example we are going to consider the following priors for
the parameters</p>
<p><span class="math display">\[\begin{align*}
\mu &amp; \sim \Gamma(0.3, 0.6) \\
K &amp; \sim \text{Unif}(0,10) \\
\alpha &amp; \sim \text{Unif}(0,10) \\
c &amp; \sim \text{Unif}(0,10) \\
p &amp; \sim \text{Unif}(1,10)
\end{align*}\]</span></p>
<p>To <code>list</code> of link functions corresponding to the above
priors is</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># set copula transformations list</span></span>
<span><span class="va">link.f</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  mu <span class="op">=</span> \<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="../reference/gamma_t.html">gamma_t</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">0.3</span>, <span class="fl">0.6</span><span class="op">)</span>,</span>
<span>  K <span class="op">=</span> \<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="../reference/unif_t.html">unif_t</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">0</span>, <span class="fl">10</span><span class="op">)</span>,</span>
<span>  alpha <span class="op">=</span> \<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="../reference/unif_t.html">unif_t</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">0</span>, <span class="fl">10</span><span class="op">)</span>,</span>
<span>  c_ <span class="op">=</span> \<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="../reference/unif_t.html">unif_t</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">0</span>, <span class="fl">10</span><span class="op">)</span>,</span>
<span>  p <span class="op">=</span> \<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="../reference/unif_t.html">unif_t</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">1</span>, <span class="fl">10</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The initial value of the parameters for the <code>inlabru</code>
algorithm must be specified in the internal scale of the parameters. For
this reason, it is useful to create a <code>list</code> of inverse link
functions so that we can specify the initial value of the parameters in
the ETAS scale and easily retrieve the corresponding value of the
parameters in the internal scale. This can be done as shown below</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># set inverse copula transformations list</span></span>
<span><span class="va">inv.link.f</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  mu <span class="op">=</span> \<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="../reference/inv_gamma_t.html">inv_gamma_t</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">0.3</span>, <span class="fl">0.6</span><span class="op">)</span>,</span>
<span>  K <span class="op">=</span> \<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="../reference/inv_unif_t.html">inv_unif_t</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">0</span>, <span class="fl">10</span><span class="op">)</span>,</span>
<span>  alpha <span class="op">=</span> \<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="../reference/inv_unif_t.html">inv_unif_t</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">0</span>, <span class="fl">10</span><span class="op">)</span>,</span>
<span>  c_ <span class="op">=</span> \<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="../reference/inv_unif_t.html">inv_unif_t</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">0</span>, <span class="fl">10</span><span class="op">)</span>,</span>
<span>  p <span class="op">=</span> \<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="../reference/inv_unif_t.html">inv_unif_t</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">1</span>, <span class="fl">10</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The initial value of the parameters have to be specified as a
<code>list</code> with names <code>th.mu</code>, <code>th.K</code>,
<code>th.alpha</code>, <code>th.c</code>, and <code>th.p</code>, where,
for example, <code>th.mu</code> corresponds to the initial value of
parameter <span class="math inline">\(\mu\)</span> in the internal
scale. The initial value of the parameters is important to ensure that
the algorithm will be able to converge. Indeed, if we start the
algorithm from values of the parameters causing numerical problems, we
may prevent the algorithm to converge. In our experience, setting the
initial values such that each parameter is not (e.g.Â <span class="math inline">\(&lt; 10^{-5}\)</span>) or (e.g.Â <span class="math inline">\(&gt; 10^2\)</span>) is a safe choice. The code
below uses the following initial values of the parameters <span class="math inline">\(\mu_{\text{init}} = 0.5, K_{\text{init}} = 0.1,
\alpha_{\text{init}} = 1, c_{\text{init}} = 0.1, p_{\text{init}} =
1.1\)</span></p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># set up list of initial values</span></span>
<span><span class="va">th.init</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  th.mu <span class="op">=</span> <span class="va">inv.link.f</span><span class="op">$</span><span class="fu">mu</span><span class="op">(</span><span class="fl">0.5</span><span class="op">)</span>,</span>
<span>  th.K <span class="op">=</span> <span class="va">inv.link.f</span><span class="op">$</span><span class="fu">K</span><span class="op">(</span><span class="fl">0.1</span><span class="op">)</span>,</span>
<span>  th.alpha <span class="op">=</span> <span class="va">inv.link.f</span><span class="op">$</span><span class="fu">alpha</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>,</span>
<span>  th.c <span class="op">=</span> <span class="va">inv.link.f</span><span class="op">$</span><span class="fu">c_</span><span class="op">(</span><span class="fl">0.1</span><span class="op">)</span>,</span>
<span>  th.p <span class="op">=</span> <span class="va">inv.link.f</span><span class="op">$</span><span class="fu">p</span><span class="op">(</span><span class="fl">1.1</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Also the <code>inlabru</code> options have to be provided in a
<code>list</code>, the main elements of the <code>list</code> are:</p>
<ul>
<li>
<code>bru_verbose</code>: number indicating the type of visual
output. Set it to 0 for no output.</li>
<li>
<code>bru_max_iter</code>: maximum number of iterations. If we do
not set <code>max_step</code> the <code>inlabru</code> algorithm stops
when the stopping criterion is met. However, setting
<code>max_step</code> to values smaller than 1 forces the algorithm to
run for exactly <code>bru_max_iter</code> iterations.</li>
<li>
<code>bru_method</code>: for what is relevant here, the only thing
that we may need to set is the <code>max_step</code> argument. If the
algorithm does not converge without fixing a <code>max_step</code> then
we suggest to try to fix it to some value below 1, in our experience
<span class="math inline">\(0.5\)</span> or <span class="math inline">\(0.2\)</span> works well. In the example below the
line setting <code>bru_method</code> is commented.</li>
<li>
<code>bru_initial</code>: <code>list</code> of initial values
created before.</li>
</ul>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># set up list of bru options</span></span>
<span><span class="va">bru.opt.list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  bru_verbose <span class="op">=</span> <span class="fl">3</span>, <span class="co"># type of visual output</span></span>
<span>  bru_max_iter <span class="op">=</span> <span class="fl">70</span>, <span class="co"># maximum number of iterations</span></span>
<span>  <span class="co"># bru_method = list(max_step = 0.5),</span></span>
<span>  bru_initial <span class="op">=</span> <span class="va">th.init</span></span>
<span><span class="op">)</span> <span class="co"># parameters initial values</span></span></code></pre></div>
<p>Lastly, we need to prepare the data from the model fitting. The data
must be provided as a <code>data.frame</code> with at least 3 columns
with names <code>ts</code> corresponding to the occurrence time of the
events, <code>magnitudes</code> corresponding to the magnitude, and
<code>idx.p</code> with an event identifier. The events in the
<code>data.frame</code> must be sorted with respect to the occurrence
time. The synthetic catalogue we have generated at the beginning already
has the columns <code>ts</code> and <code>magnitudes</code>, but it is
sorted by generation and not time. The code below sort the rows of the
<code>data.frame</code> and adds the event identifier</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># sort catalogue by occurrence time</span></span>
<span><span class="va">synth.cat.df</span> <span class="op">&lt;-</span> <span class="va">synth.cat.df</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">synth.cat.df</span><span class="op">$</span><span class="va">ts</span><span class="op">)</span>, <span class="op">]</span></span>
<span><span class="co"># add event identifier</span></span>
<span><span class="va">synth.cat.df</span><span class="op">$</span><span class="va">idx.p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">synth.cat.df</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="model-fitting">Model Fitting<a class="anchor" aria-label="anchor" href="#model-fitting"></a>
</h2>
<p>The function <code>Temporal.ETAS</code> fit the ETAS model and
returns a <code>bru</code> object as output. The required inputs
are:</p>
<ul>
<li>
<code>total.data</code>: <code>data.frame</code> containing the
observed events. It have to be in the format described in the previous
Section.</li>
<li>
<code>M0</code>: cutoff magnitude. All the events in
<code>total.data</code> must have magnitude greater or equal to this
number.</li>
<li>
<code>T1</code>: starting time of the time interval on which we want
to fit the model.</li>
<li>
<code>T2</code>: end time of the time interval on which we want to
fit the model.</li>
<li>
<code>link.functions</code>: <code>list</code> of copula
transformation functions in the format described in previous
sections.</li>
<li>
<code>coef.t.</code>, <code>delta.t.</code>, <code>N.max.</code>:
parameters of the temporal binning. The binning strategy is described in
Appendix B of the paper <a href="https://onlinelibrary.wiley.com/doi/full/10.1002/env.2798" class="external-link">Approximation
of Bayesian Hawkes process with <code>inlabru</code></a>. The parameters
corresponds to <code>coef.t.</code><span class="math inline">\(=\delta\)</span>, <code>delta.t.</code><span class="math inline">\(=\Delta\)</span>, and <code>N.max.</code><span class="math inline">\(=n_{\max}\)</span>.</li>
<li>
<code>bru.opt</code>: <code>list</code> of <code>inlabru</code>
options as described in the previous Section.</li>
</ul>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">synth.fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Temporal.ETAS.html">Temporal.ETAS</a></span><span class="op">(</span></span>
<span>  total.data <span class="op">=</span> <span class="va">synth.cat.df</span>,</span>
<span>  M0 <span class="op">=</span> <span class="va">M0</span>,</span>
<span>  T1 <span class="op">=</span> <span class="va">T1</span>,</span>
<span>  T2 <span class="op">=</span> <span class="va">T2</span>,</span>
<span>  link.functions <span class="op">=</span> <span class="va">link.f</span>,</span>
<span>  coef.t. <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  delta.t. <span class="op">=</span> <span class="fl">0.1</span>,</span>
<span>  N.max. <span class="op">=</span> <span class="fl">5</span>,</span>
<span>  bru.opt <span class="op">=</span> <span class="va">bru.opt.list</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Start creating grid... </span></span>
<span><span class="co">#&gt; Finished creating grid, time  0.5635509</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="check-marginal-posterior-distributions">Check marginal posterior distributions<a class="anchor" aria-label="anchor" href="#check-marginal-posterior-distributions"></a>
</h2>
<p>In order to retrieve the marginal posterior distributions of the
parameter we need to provide a <code>list</code> containing two
elements: <code>model.fit</code> which is a <code>bru</code> object
containing the fitted model, and <code>link.functions</code> which is
the <code>list</code> of link functions created before.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># create input list to explore model output</span></span>
<span><span class="va">input_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  model.fit <span class="op">=</span> <span class="va">synth.fit</span>,</span>
<span>  link.functions <span class="op">=</span> <span class="va">link.f</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Once the <code>list</code> has been created, the function
<code>get_posterior_param</code> returns the marginal posterior
distribution of the parameters in the ETAS scale. The function returns a
<code>list</code> with two elements: <code>post.df</code> is a
<code>data.frame</code> with three columns, <code>x</code> indicating
the value of the parameter, <code>y</code> indicating the corresponding
value of the marginal posterior distribution, and <code>param</code>
which is a parameter identifier. The output <code>list</code> also
contains <code>post.plot</code> which is a <code>ggplot</code> object
containing the plot of the marginal posterior distributions for each
parameter. The code below retrieve the marginal posterior distribution
of the parameters and plot them along with the true value of the
parameters represented by the vertical dashed lines.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># retrieve marginal posterior distributions</span></span>
<span><span class="va">post.list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_posterior_param.html">get_posterior_param</a></span><span class="op">(</span>input.list <span class="op">=</span> <span class="va">input_list</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># create data.frame of true value of parameters</span></span>
<span><span class="va">df.true.param</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">true.param</span><span class="op">)</span>,</span>
<span>  param <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">true.param</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># add to the marginal posterior distribution of the parameters the true value of the parameters.</span></span>
<span><span class="va">post.list</span><span class="op">$</span><span class="va">post.plot</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">df.true.param</span>,</span>
<span>    mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="va">x</span><span class="op">)</span>, linetype <span class="op">=</span> <span class="fl">2</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p><img src="tutorial_synth_files/figure-html/unnamed-chunk-12-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="sampling-the-joint-posterior-distribution">Sampling the joint posterior distribution<a class="anchor" aria-label="anchor" href="#sampling-the-joint-posterior-distribution"></a>
</h2>
<p>The function <code>post_sampling</code> generate samples from the
joint posterior of ETAS parameters. The function takes in input:</p>
<ul>
<li>
<code>input.list</code>: a list with a <code>model.fit</code>
element and a <code>link.functions</code> elements as described
above.</li>
<li>
<code>n.samp</code>: number of posterior samples.</li>
<li>
<code>max.batch</code>: the number of posterior samples to be
generated simultaneously. If <code>n.samp</code><span class="math inline">\(&gt;\)</span><code>max.batch</code>, then, the
samples are generated in parallel in batches of maximum size equal to
<code>max.batch</code>. Default is <span class="math inline">\(1000\)</span>.</li>
<li>
<code>ncore</code>: number of cores to be used in parallel when
<code>n.samp</code><span class="math inline">\(&gt;\)</span><code>max.batch</code>.</li>
</ul>
<p>The function returns a <code>data.frame</code> with columns
corresponding to the ETAS parameters</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">post.samp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/post_sampling.html">post_sampling</a></span><span class="op">(</span></span>
<span>  input.list <span class="op">=</span> <span class="va">input_list</span>,</span>
<span>  n.samp <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>  max.batch <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>  ncore <span class="op">=</span> <span class="fl">1</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">post.samp</span><span class="op">)</span></span>
<span><span class="co">#&gt;          mu          K    alpha         c        p</span></span>
<span><span class="co">#&gt; 1 0.3313594 0.06213181 2.622306 0.1370523 1.301888</span></span>
<span><span class="co">#&gt; 2 0.2944582 0.04940535 2.584373 0.1482548 1.236385</span></span>
<span><span class="co">#&gt; 3 0.3617445 0.05013471 2.501793 0.2749193 1.455744</span></span>
<span><span class="co">#&gt; 4 0.3461104 0.06513873 2.406373 0.2820508 1.446610</span></span>
<span><span class="co">#&gt; 5 0.2880405 0.03930956 2.585837 0.2202680 1.329543</span></span>
<span><span class="co">#&gt; 6 0.3142970 0.04254604 2.471594 0.3291435 1.393758</span></span></code></pre></div>
<p>The posterior samples can then be used to estimate the posterior
distribution of functions of the parameters.</p>
</div>
<div class="section level2">
<h2 id="triggering-function-and-omori-law">Triggering function and Omori law<a class="anchor" aria-label="anchor" href="#triggering-function-and-omori-law"></a>
</h2>
<p>Interesting functions of the parameters are the triggering function
and the Omori law. We can estimate the posterior distribution of these
functions using the samples from the joint posterior distribution of the
parameters obtained in the previous section.</p>
<p>The functions <code>triggering_fun_plot</code> provides a plot of the
quantiles of the posterior distribution of the triggering function <span class="math inline">\(g(t-t_h, mh)\)</span>, namely,</p>
<p><span class="math display">\[
g(t - t_h, m_h) = K\exp\{\alpha(m_h - M_0)\}\left(\frac{t - t_h}{c} +
1\right)^{-p}
\]</span></p>
<p>The function takes in input</p>
<ul>
<li>
<code>input.list</code>: the input list as defined for the functions
used previously.</li>
<li>
<code>post.samp</code>: a <code>data.frame</code> of samples from
the posterior distribution of the parameters. If it is
<code>NULL</code>, then <code>n.samp</code> samples are generated from
the posterior.</li>
<li>
<code>n.samp</code>: number of posterior samples of the parameters
to be used or generated.</li>
<li>
<code>magnitude</code>: the magnitude of the event (<span class="math inline">\(m_h\)</span>).</li>
<li>
<code>t.end</code>: the maximum value of <span class="math inline">\(t\)</span> for the plot.</li>
<li>
<code>n.breaks</code>: the number of breaks in which the interval
<span class="math inline">\((0, \texttt{t.end})\)</span> is
divided.</li>
</ul>
<p>The function returns a <code>ggplot</code> object. For each sample of
the parameters the triggering function between <span class="math inline">\(0\)</span> and <code>t.end</code> is calculated.
The black solid lines represents the <span class="math inline">\(95\%\)</span> posterior interval of the function,
the grey lines represent the triggering function calculated with the
posterior samples, and the horizontal red lines represent the <span class="math inline">\(95\%\)</span> posterior interval of the background
rate <span class="math inline">\(\mu\)</span>. The function
<code>triggering_plot_prior</code> does the same but using parameters
sampled from the priors of the parameters.</p>
<p>The code below creates the plot of the posterior of the triggering
function and adds the triggering function calculated with the true
parameter values in blue. We need to add the argument <code>M0</code> to
the <code>input_list</code> to use the function
<code>triggering_fun_plot</code>.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># add cutoff magnitude to input_list</span></span>
<span><span class="va">input_list</span><span class="op">$</span><span class="va">M0</span> <span class="op">&lt;-</span> <span class="va">M0</span></span>
<span></span>
<span><span class="co"># generate triggering function plot</span></span>
<span><span class="va">trig.plot</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/triggering_fun_plot.html">triggering_fun_plot</a></span><span class="op">(</span></span>
<span>  input.list <span class="op">=</span> <span class="va">input_list</span>,</span>
<span>  post.samp <span class="op">=</span> <span class="va">post.samp</span>,</span>
<span>  n.samp <span class="op">=</span> <span class="cn">NULL</span>, magnitude <span class="op">=</span> <span class="fl">4</span>,</span>
<span>  t.end <span class="op">=</span> <span class="fl">5</span>, n.breaks <span class="op">=</span> <span class="fl">100</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># set times at which calculate the true triggering function</span></span>
<span><span class="va">t.breaks</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">1e-6</span>, <span class="fl">5</span>, length.out <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span>
<span><span class="co"># calculate the function</span></span>
<span><span class="va">true.trig</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/gt.html">gt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">true.param</span><span class="op">)</span>, t <span class="op">=</span> <span class="va">t.breaks</span>, th <span class="op">=</span> <span class="fl">0</span>, mh <span class="op">=</span> <span class="fl">4</span>, M0 <span class="op">=</span> <span class="va">M0</span><span class="op">)</span></span>
<span><span class="co"># store in data.frame for plotting</span></span>
<span><span class="va">true.trig.df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>ts <span class="op">=</span> <span class="va">t.breaks</span>, trig.fun <span class="op">=</span> <span class="va">true.trig</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># add the true triggering function to the plot</span></span>
<span><span class="va">trig.plot</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">true.trig.df</span>,</span>
<span>    mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">ts</span>, y <span class="op">=</span> <span class="va">trig.fun</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"blue"</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p><img src="tutorial_synth_files/figure-html/unnamed-chunk-14-1.png" width="700"></p>
<p>The functions <code>omori_plot_posterior</code> does the same as the
function <code>triggering_fun_plot</code> but considering only</p>
<p><span class="math display">\[
\left(\frac{t- t_h}{c} + 1\right)^{-p}
\]</span> instead of the whole triggering function and without the
background rate.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">omori.plot</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/omori_plot_posterior.html">omori_plot_posterior</a></span><span class="op">(</span>input.list <span class="op">=</span> <span class="va">input_list</span>, post.samp <span class="op">=</span> <span class="va">post.samp</span>, n.samp <span class="op">=</span> <span class="cn">NULL</span>, t.end <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span></span>
<span><span class="va">true.omori</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/omori.html">omori</a></span><span class="op">(</span>theta <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">true.param</span><span class="op">)</span>, t <span class="op">=</span> <span class="va">t.breaks</span>, ti <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">true.omori.df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>ts <span class="op">=</span> <span class="va">t.breaks</span>, omori.fun <span class="op">=</span> <span class="va">true.omori</span><span class="op">)</span></span>
<span></span>
<span><span class="va">omori.plot</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">true.omori.df</span>,</span>
<span>    mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">ts</span>, y <span class="op">=</span> <span class="va">omori.fun</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"blue"</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p><img src="tutorial_synth_files/figure-html/unnamed-chunk-15-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="comparison-between-different-fitted-models">Comparison between different fitted models<a class="anchor" aria-label="anchor" href="#comparison-between-different-fitted-models"></a>
</h2>
<p>It is interesting to fit the model on multiple synthetic catalogues
and compare the parameters posterior distributions obtained with
different catalogues. In this section, we are going to generate a second
synthetic catalogue, fit the model, and compare the posterior
distributions with the ones obtained before. For the second catalogue we
impose a large event with magnitude <span class="math inline">\(6\)</span> happening in the midpoint of the time
interval.</p>
<p>The first step is to set the <code>data.frame</code> of known events
and generate a second synthetic catalogue</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># set up data.frame of imposed events</span></span>
<span><span class="va">Ht.imposed</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  ts <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">T1</span>, <span class="va">T2</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  magnitudes <span class="op">=</span> <span class="fl">6</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># generate second catalogue</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">synth.cat.list.2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/generate_temporal_ETAS_synthetic.html">generate_temporal_ETAS_synthetic</a></span><span class="op">(</span></span>
<span>  theta <span class="op">=</span> <span class="va">true.param</span>,</span>
<span>  beta.p <span class="op">=</span> <span class="va">beta.p</span>,</span>
<span>  M0 <span class="op">=</span> <span class="va">M0</span>,</span>
<span>  T1 <span class="op">=</span> <span class="va">T1</span>,</span>
<span>  T2 <span class="op">=</span> <span class="va">T2</span>,</span>
<span>  Ht <span class="op">=</span> <span class="va">Ht.imposed</span>,</span>
<span>  ncore <span class="op">=</span> <span class="fl">1</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># transform it in a data.frame</span></span>
<span><span class="va">synth.cat.df.2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="va">synth.cat.list.2</span><span class="op">)</span></span></code></pre></div>
<p>Counting the number of background events and aftershocks in this case
is slightly different from before. In fact, we count the imposed event
as a background event, and the aftershocks need to include also the
event with <code>gen = 0</code> which are the ones induced by the
imposed event which in this case are 192.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">synth.cat.df.2</span><span class="op">$</span><span class="va">gen</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 192</span></span></code></pre></div>
<p>Below the comparison between the number of events in the two
catalogues. Notice that the background events are roughly the same which
is expected given that the time interval is the same.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span></span>
<span>  first <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    N <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">synth.cat.df</span><span class="op">)</span>,</span>
<span>    N.bkg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">synth.cat.df</span><span class="op">$</span><span class="va">gen</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>    N.after <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">synth.cat.df</span><span class="op">$</span><span class="va">gen</span> <span class="op">&gt;</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  second <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    N <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">synth.cat.df.2</span><span class="op">)</span>,</span>
<span>    N.bkg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">synth.cat.df.2</span><span class="op">$</span><span class="va">gen</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">|</span> <span class="va">synth.cat.df.2</span><span class="op">$</span><span class="va">gen</span> <span class="op">==</span> <span class="op">-</span><span class="fl">1</span><span class="op">)</span>,</span>
<span>    N.after <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">synth.cat.df.2</span><span class="op">$</span><span class="va">gen</span> <span class="op">&gt;</span> <span class="fl">1</span> <span class="op">|</span> <span class="va">synth.cat.df.2</span><span class="op">$</span><span class="va">gen</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt;          N N.bkg N.after</span></span>
<span><span class="co">#&gt; first  288   112     176</span></span>
<span><span class="co">#&gt; second 408   104     304</span></span></code></pre></div>
<p>Then, we just need to set up the <code>data.frame</code> for model
fitting. For all the other inputs we can use the ones created for the
first model fit.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">synth.cat.df.2</span> <span class="op">&lt;-</span> <span class="va">synth.cat.df.2</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">synth.cat.df.2</span><span class="op">$</span><span class="va">ts</span><span class="op">)</span>, <span class="op">]</span></span>
<span><span class="va">synth.cat.df.2</span><span class="op">$</span><span class="va">idx.p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">synth.cat.df.2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">synth.fit.2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Temporal.ETAS.html">Temporal.ETAS</a></span><span class="op">(</span></span>
<span>  total.data <span class="op">=</span> <span class="va">synth.cat.df.2</span>,</span>
<span>  M0 <span class="op">=</span> <span class="va">M0</span>,</span>
<span>  T1 <span class="op">=</span> <span class="va">T1</span>,</span>
<span>  T2 <span class="op">=</span> <span class="va">T2</span>,</span>
<span>  link.functions <span class="op">=</span> <span class="va">link.f</span>,</span>
<span>  coef.t. <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  delta.t. <span class="op">=</span> <span class="fl">0.1</span>,</span>
<span>  N.max. <span class="op">=</span> <span class="fl">5</span>,</span>
<span>  bru.opt <span class="op">=</span> <span class="va">bru.opt.list</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Start creating grid... </span></span>
<span><span class="co">#&gt; Finished creating grid, time  0.9975915</span></span></code></pre></div>
<p>Now, to extract the marginal posterior distributions, we need to
create the <code>input_list</code> of the second model fit.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">input_list.2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  model.fit <span class="op">=</span> <span class="va">synth.fit.2</span>,</span>
<span>  link.functions <span class="op">=</span> <span class="va">link.f</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Now, we can retrieve the marginal posterior distributions provided by
the model fitted on the second catalogue and compare them with the ones
obtained before.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># retrieve marginal posterior distributions</span></span>
<span><span class="va">post.list.2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_posterior_param.html">get_posterior_param</a></span><span class="op">(</span>input.list <span class="op">=</span> <span class="va">input_list.2</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># set model identifier</span></span>
<span><span class="va">post.list</span><span class="op">$</span><span class="va">post.df</span><span class="op">$</span><span class="va">cat.used</span> <span class="op">&lt;-</span> <span class="st">"first catalogue"</span></span>
<span><span class="va">post.list.2</span><span class="op">$</span><span class="va">post.df</span><span class="op">$</span><span class="va">cat.used</span> <span class="op">&lt;-</span> <span class="st">"second catalogue"</span></span>
<span></span>
<span><span class="co"># bind marginal posterior data.frames</span></span>
<span><span class="va">bind.post.df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">post.list</span><span class="op">$</span><span class="va">post.df</span>, <span class="va">post.list.2</span><span class="op">$</span><span class="va">post.df</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># plot them</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">bind.post.df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, color <span class="op">=</span> <span class="va">cat.used</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span>facets <span class="op">=</span> <span class="op">~</span><span class="va">param</span>, scales <span class="op">=</span> <span class="st">"free"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"param"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"pdf"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">df.true.param</span>,</span>
<span>    mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="va">x</span><span class="op">)</span>, linetype <span class="op">=</span> <span class="fl">2</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p><img src="tutorial_synth_files/figure-html/unnamed-chunk-21-1.png" width="700"></p>
<p>The process shown here can be extended to multiple (<span class="math inline">\(&gt;2\)</span>) input catalogues in order to study
if the parameters are identifiable. Also, using characteristics of the
input catalogue as catalogue identifier we can study the change in the
posterior distribution as the characteristic of the input catalogue
changes. An interesting example is the number of events in the
catalogue, and studying how the marginal posterior distributions change
as we increase or decrease the number of events.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Francesco Serafini, Mark Naylor, Finn Lindgren.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
